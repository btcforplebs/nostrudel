{"version":3,"file":"pair-DsOC6VPI.js","sources":["../../src/views/relays/webrtc/pair.tsx"],"sourcesContent":["import { useEffect, useMemo } from \"react\";\nimport {\n  Alert,\n  AlertIcon,\n  Box,\n  Button,\n  Flex,\n  FormControl,\n  FormHelperText,\n  FormLabel,\n  Heading,\n  IconButton,\n  Input,\n  Text,\n  useDisclosure,\n  useForceUpdate,\n  useInterval,\n} from \"@chakra-ui/react\";\nimport { getPublicKey, kinds, nip19 } from \"nostr-tools\";\n\nimport BackButton from \"../../../components/router/back-button\";\nimport webRtcRelaysService from \"../../../services/webrtc-relays\";\nimport useSubject from \"../../../hooks/use-subject\";\nimport localSettings from \"../../../services/local-settings\";\nimport { CopyIconButton } from \"../../../components/copy-icon-button\";\nimport UserAvatar from \"../../../components/user/user-avatar\";\nimport UserName from \"../../../components/user/user-name\";\nimport QrCodeSvg from \"../../../components/qr-code/qr-code-svg\";\nimport { QrCodeIcon } from \"../../../components/icons\";\nimport { useForm } from \"react-hook-form\";\nimport dayjs from \"dayjs\";\nimport { usePublishEvent } from \"../../../providers/global/publish-provider\";\nimport useCurrentAccount from \"../../../hooks/use-current-account\";\nimport useUserProfile from \"../../../hooks/use-user-profile\";\nimport { useAsync } from \"react-use\";\n\nfunction NameForm() {\n  const publish = usePublishEvent();\n  const { register, handleSubmit, formState, reset } = useForm({ defaultValues: { name: \"\" }, mode: \"all\" });\n\n  const { value: pubkey } = useAsync(async () => webRtcRelaysService.broker.signer.getPublicKey());\n  const metadata = useUserProfile(pubkey);\n  useEffect(() => {\n    if (metadata?.name) reset({ name: metadata.name }, { keepDirty: false, keepTouched: false });\n  }, [metadata?.name]);\n\n  const submit = handleSubmit(async (values) => {\n    const event = await webRtcRelaysService.broker.signer.signEvent({\n      kind: kinds.Metadata,\n      created_at: dayjs().unix(),\n      tags: [],\n      content: JSON.stringify({ name: values.name }),\n    });\n\n    await publish(\"Set WebRTC name\", event);\n  });\n\n  return (\n    <Flex direction=\"column\" gap=\"2\" as=\"form\" onSubmit={submit}>\n      <FormControl isRequired>\n        <FormLabel>Local relay name</FormLabel>\n        <Flex gap=\"2\">\n          <Input {...register(\"name\", { required: true })} isRequired autoComplete=\"off\" />\n          <Button type=\"submit\" isLoading={formState.isSubmitting}>\n            Set\n          </Button>\n        </Flex>\n        <FormHelperText>The name that will be shown to other peers</FormHelperText>\n      </FormControl>\n    </Flex>\n  );\n}\n\nexport default function WebRtcPairView() {\n  const update = useForceUpdate();\n  useInterval(update, 1000);\n  useEffect(() => {\n    webRtcRelaysService.broker.on(\"call\", update);\n\n    return () => {\n      webRtcRelaysService.broker.off(\"call\", update);\n    };\n  }, [update]);\n\n  const account = useCurrentAccount();\n  const showQrCode = useDisclosure();\n\n  const identity = useSubject(localSettings.webRtcLocalIdentity);\n  const pubkey = useMemo(() => getPublicKey(identity), [identity]);\n  const npub = useMemo(() => nip19.npubEncode(pubkey), [pubkey]);\n\n  const uri = \"webrtc+nostr:\" + npub;\n\n  return (\n    <Flex gap=\"2\" direction=\"column\" overflow=\"auto hidden\" flex={1} px={{ base: \"2\", lg: 0 }}>\n      <Flex gap=\"2\" alignItems=\"center\" wrap=\"wrap\">\n        <BackButton hideFrom=\"lg\" size=\"sm\" />\n        <Heading size=\"lg\">Pair with WebRTC relay</Heading>\n      </Flex>\n\n      <Text fontStyle=\"italic\" mt=\"-2\">\n        Share this URI with other users to allow them to connect to your local relay\n      </Text>\n\n      <Flex gap=\"2\" alignItems=\"center\">\n        <UserAvatar pubkey={pubkey} size=\"sm\" />\n        <Input readOnly userSelect=\"all\" value={uri} />\n        <IconButton icon={<QrCodeIcon boxSize=\"1.5em\" />} aria-label=\"Show QR Code\" onClick={showQrCode.onToggle} />\n        <CopyIconButton value={uri} aria-label=\"Copy Npub\" />\n      </Flex>\n\n      {showQrCode.isOpen && (\n        <Box w=\"full\" maxW=\"sm\" mx=\"auto\">\n          <QrCodeSvg content={uri} />\n        </Box>\n      )}\n\n      {pubkey !== account?.pubkey && <NameForm />}\n\n      <Heading size=\"md\" mt=\"4\">\n        Connection Requests:\n      </Heading>\n      {webRtcRelaysService.pendingIncoming.length > 0 ? (\n        <>\n          {webRtcRelaysService.pendingIncoming.map((event) => (\n            <Flex key={event.id} borderWidth=\"1px\" rounded=\"md\" p=\"2\" alignItems=\"center\" gap=\"2\">\n              <UserAvatar pubkey={event.pubkey} size=\"sm\" />\n              <UserName pubkey={event.pubkey} />\n              <Button\n                size=\"sm\"\n                ml=\"auto\"\n                colorScheme=\"green\"\n                onClick={() => {\n                  webRtcRelaysService.acceptCall(event);\n                  update();\n                }}\n              >\n                Accept\n              </Button>\n            </Flex>\n          ))}\n        </>\n      ) : (\n        <Alert status=\"info\">\n          <AlertIcon />\n          No connections requests\n        </Alert>\n      )}\n    </Flex>\n  );\n}\n"],"names":["NameForm","publish","usePublishEvent","register","handleSubmit","formState","reset","useForm","pubkey","useAsync","webRtcRelaysService","metadata","useUserProfile","useEffect","submit","values","event","kinds","dayjs","jsx","Flex","jsxs","FormControl","FormLabel","Input","Button","FormHelperText","WebRtcPairView","update","useForceUpdate","useInterval","account","useCurrentAccount","showQrCode","useDisclosure","identity","useSubject","localSettings","useMemo","getPublicKey","uri","nip19","BackButton","Heading","Text","UserAvatar","IconButton","QrCodeIcon","CopyIconButton","Box","QrCodeSvg","UserName","Alert","AlertIcon"],"mappings":"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"}