{"version":3,"file":"index-BwUX-d_Q.js","sources":["../../src/views/communities/index.tsx"],"sourcesContent":["import { useMemo } from \"react\";\nimport {\n  Button,\n  ButtonGroup,\n  Center,\n  Drawer,\n  DrawerBody,\n  DrawerCloseButton,\n  DrawerContent,\n  DrawerHeader,\n  DrawerOverlay,\n  Flex,\n  Heading,\n  Link,\n  Switch,\n  Text,\n  useDisclosure,\n} from \"@chakra-ui/react\";\nimport { kinds } from \"nostr-tools\";\nimport { Link as RouterLink, useNavigate } from \"react-router-dom\";\nimport { Navigate } from \"react-router-dom\";\nimport dayjs from \"dayjs\";\n\nimport VerticalPageLayout from \"../../components/vertical-page-layout\";\nimport { ErrorBoundary } from \"../../components/error-boundary\";\nimport useUserCommunitiesList from \"../../hooks/use-user-communities-list\";\nimport useCurrentAccount from \"../../hooks/use-current-account\";\nimport CommunityCard from \"./components/community-card\";\nimport CommunityCreateModal, { FormValues } from \"./components/community-create-modal\";\nimport { DraftNostrEvent } from \"../../types/nostr-event\";\nimport {\n  COMMUNITY_APPROVAL_KIND,\n  COMMUNITY_DEFINITION_KIND,\n  buildApprovalMap,\n  getCommunityMods,\n  getCommunityName,\n} from \"../../helpers/nostr/communities\";\nimport { getImageSize } from \"../../helpers/image\";\nimport { useReadRelays } from \"../../hooks/use-client-relays\";\nimport useTimelineLoader from \"../../hooks/use-timeline-loader\";\nimport useUserMuteFilter from \"../../hooks/use-user-mute-filter\";\nimport { useTimelineCurserIntersectionCallback } from \"../../hooks/use-timeline-cursor-intersection-callback\";\nimport useReplaceableEvents from \"../../hooks/use-replaceable-events\";\nimport { getEventCoordinate, sortByDate } from \"../../helpers/nostr/event\";\nimport IntersectionObserverProvider from \"../../providers/local/intersection-observer\";\nimport ApprovedEvent from \"../community/components/community-approved-post\";\nimport TimelineActionAndStatus from \"../../components/timeline/timeline-action-and-status\";\nimport { usePublishEvent } from \"../../providers/global/publish-provider\";\nimport { createCoordinate } from \"../../classes/batch-kind-pubkey-loader\";\n\nfunction CommunitiesHomePage() {\n  const publish = usePublishEvent();\n  const navigate = useNavigate();\n  const account = useCurrentAccount()!;\n  const createModal = useDisclosure();\n\n  const readRelays = useReadRelays();\n  const { pointers: communityCoordinates } = useUserCommunitiesList(account.pubkey, readRelays, {\n    alwaysRequest: true,\n  });\n  const communities = useReplaceableEvents(communityCoordinates, readRelays).sort(sortByDate);\n\n  const createCommunity = async (values: FormValues) => {\n    const draft: DraftNostrEvent = {\n      kind: COMMUNITY_DEFINITION_KIND,\n      created_at: dayjs().unix(),\n      content: \"\",\n      tags: [[\"d\", values.name]],\n    };\n\n    if (values.description) draft.tags.push([\"description\", values.description]);\n    if (values.banner) {\n      try {\n        const size = await getImageSize(values.banner);\n        draft.tags.push([\"image\", values.banner, `${size.width}x${size.height}`]);\n      } catch (e) {\n        draft.tags.push([\"image\", values.banner]);\n      }\n    }\n    for (const pubkey of values.mods) draft.tags.push([\"p\", pubkey, \"\", \"moderator\"]);\n    for (const url of values.relays) draft.tags.push([\"relay\", url]);\n    for (const [url, name] of values.links) draft.tags.push(name ? [\"r\", url, name] : [\"r\", url]);\n    // if (values.ranking) draft.tags.push([\"rank_mode\", values.ranking]);\n\n    const pub = await publish(\"Create Community\", draft, values.relays, false);\n\n    if (pub) navigate(`/c/${getCommunityName(pub.event)}/${pub.event.pubkey}`);\n  };\n\n  const { loader, timeline: events } = useTimelineLoader(\n    `all-communities-timeline`,\n    readRelays,\n    communityCoordinates.length > 0\n      ? {\n          kinds: [kinds.ShortTextNote, kinds.Repost, kinds.GenericRepost, COMMUNITY_APPROVAL_KIND],\n          \"#a\": communityCoordinates.map((p) => createCoordinate(p.kind, p.pubkey, p.identifier)),\n        }\n      : undefined,\n  );\n\n  const showUnapproved = useDisclosure();\n  const muteFilter = useUserMuteFilter();\n  const mods = useMemo(() => {\n    const set = new Set<string>();\n    for (const community of communities) {\n      for (const pubkey of getCommunityMods(community)) {\n        set.add(pubkey);\n      }\n    }\n    return Array.from(set);\n  }, [communities]);\n\n  const approvalMap = buildApprovalMap(events, mods);\n\n  const approved = events\n    .filter((e) => e.kind !== COMMUNITY_APPROVAL_KIND && (showUnapproved.isOpen ? true : approvalMap.has(e.id)))\n    .map((event) => ({ event, approvals: approvalMap.get(event.id) }))\n    .filter((e) => !muteFilter(e.event));\n\n  const callback = useTimelineCurserIntersectionCallback(loader);\n\n  const communityDrawer = useDisclosure();\n\n  return (\n    <>\n      <VerticalPageLayout>\n        <Flex gap=\"2\" alignItems=\"center\" wrap=\"wrap\">\n          <Button as={RouterLink} to=\"/communities/explore\">\n            Explore\n          </Button>\n\n          <ButtonGroup ml=\"auto\">\n            <Button onClick={createModal.onOpen}>Create</Button>\n            <Button onClick={communityDrawer.onOpen} hideFrom=\"xl\">\n              Joined\n            </Button>\n          </ButtonGroup>\n        </Flex>\n        {communities.length > 0 ? (\n          <Flex gap=\"4\" overflow=\"hidden\">\n            <Flex direction=\"column\" gap=\"2\" flex={1} overflow=\"hidden\">\n              <Flex alignItems=\"center\" gap=\"4\">\n                <Heading size=\"lg\">Latest Posts</Heading>\n                <Switch isChecked={showUnapproved.isOpen} onChange={showUnapproved.onToggle}>\n                  Show Unapproved\n                </Switch>\n              </Flex>\n              <IntersectionObserverProvider callback={callback}>\n                {approved.map(({ event, approvals }) => (\n                  <ApprovedEvent key={event.id} event={event} approvals={approvals ?? []} showCommunity />\n                ))}\n              </IntersectionObserverProvider>\n              <TimelineActionAndStatus timeline={loader} />\n            </Flex>\n            <Flex gap=\"2\" direction=\"column\" w=\"md\" flexShrink={0} hideBelow=\"xl\">\n              <Heading size=\"md\">Joined Communities</Heading>\n              {communities.map((community) => (\n                <ErrorBoundary key={getEventCoordinate(community)} event={community}>\n                  <CommunityCard community={community} />\n                </ErrorBoundary>\n              ))}\n            </Flex>\n          </Flex>\n        ) : (\n          <Center py=\"20\" flexDirection=\"column\" gap=\"4\">\n            <Heading size=\"md\">No communities :(</Heading>\n            <Text>\n              go find a cool one to join.{\" \"}\n              <Link as={RouterLink} to=\"/communities/explore\" color=\"blue.500\">\n                Explore\n              </Link>\n            </Text>\n          </Center>\n        )}\n      </VerticalPageLayout>\n      {createModal.isOpen && (\n        <CommunityCreateModal isOpen={createModal.isOpen} onClose={createModal.onClose} onSubmit={createCommunity} />\n      )}\n\n      <Drawer isOpen={communityDrawer.isOpen} placement=\"right\" onClose={communityDrawer.onClose} size=\"lg\">\n        <DrawerOverlay />\n        <DrawerContent>\n          <DrawerCloseButton />\n          <DrawerHeader p=\"4\">Joined Communities</DrawerHeader>\n\n          <DrawerBody display=\"flex\" flexDirection=\"column\" gap=\"2\" px=\"4\" pt=\"0\" pb=\"8\" overflowY=\"auto\">\n            {communities.map((community) => (\n              <ErrorBoundary key={getEventCoordinate(community)} event={community}>\n                <CommunityCard community={community} flexShrink={0} />\n              </ErrorBoundary>\n            ))}\n          </DrawerBody>\n        </DrawerContent>\n      </Drawer>\n    </>\n  );\n}\n\nexport default function CommunitiesHomeView() {\n  const account = useCurrentAccount();\n  return account ? <CommunitiesHomePage /> : <Navigate to=\"/communities/explore\" />;\n}\n"],"names":["CommunitiesHomePage","publish","usePublishEvent","navigate","useNavigate","account","useCurrentAccount","createModal","useDisclosure","readRelays","useReadRelays","communityCoordinates","useUserCommunitiesList","communities","useReplaceableEvents","sortByDate","createCommunity","values","draft","COMMUNITY_DEFINITION_KIND","dayjs","size","getImageSize","pubkey","url","name","pub","getCommunityName","loader","events","useTimelineLoader","kinds","COMMUNITY_APPROVAL_KIND","p","createCoordinate","showUnapproved","muteFilter","useUserMuteFilter","mods","useMemo","set","community","getCommunityMods","approvalMap","buildApprovalMap","approved","event","callback","useTimelineCurserIntersectionCallback","communityDrawer","jsxs","Fragment","VerticalPageLayout","Flex","jsx","Button","RouterLink","ButtonGroup","Heading","Switch","IntersectionObserverProvider","approvals","ApprovedEvent","TimelineActionAndStatus","ErrorBoundary","CommunityCard","getEventCoordinate","Center","Text","Link","CommunityCreateModal","Drawer","DrawerOverlay","DrawerContent","DrawerCloseButton","DrawerHeader","DrawerBody","CommunitiesHomeView","Navigate"],"mappings":"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"}