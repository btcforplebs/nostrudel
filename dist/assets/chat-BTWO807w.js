import{a6 as V,bH as W,r as o,bI as $,bJ as X,bK as N,a7 as w,k as P,t as Y,bL as f,j as e,F as S,H as Z,bM as G,E as R,bN as L,bO as J,bP as Q,ao as ee,bQ as se,ar as te,aq as ne,T as E,as as re,_ as O,bR as z,C as q,a9 as ae,aB as U,Z as _,aX as oe,$ as ie,aZ as ce,aD as le,R as ue,af as de,bS as xe,ae as ge,bo as me,bT as pe,bU as fe,f as he,bV as je,W as F,i as Ce,I as ye,bW as be,bD as ve,y as De,z as Te,bX as Me,bB as Se}from"./index-C6wlVu-O.js";import{M as ke,u as H,T as we,a as Be}from"./message-block-CcitCko1.js";function K({pubkey:s,rootId:t,...r}){const n=V(),{requestEncrypt:l}=W(),[u,i]=o.useState(""),{getValues:m,setValue:h,watch:j,handleSubmit:x,formState:c,reset:g}=$({defaultValues:{content:""},mode:"all"});j("content");const v=X(`dm-${s}`,m,g,c,{clearOnKeyChange:!0}),D=o.useRef(null),C=o.useRef(null),{onPaste:k}=N(D,m,h),y=w(s),T=x(async a=>{if(!a.content)return;i("Encrypting...");const p=await l(a.content,s),b={kind:P.EncryptedDirectMessage,content:p,tags:[["p",s]],created_at:Y().unix()};t&&b.tags.push(["e",t,"","root"]),i("Signing...");const M=await n("Send DM",b,y==null?void 0:y.inboxes);M&&(v(),g({content:""}),f.getOrCreateContainer(M.event.id,"nip04",s,p).plaintext.next(a.content),setTimeout(()=>{var A;return(A=C.current)==null?void 0:A.focus()},50)),i("")}),d=o.useRef(null);return e.jsx(S,{as:"form",gap:"2",onSubmit:T,ref:d,...r,children:u?e.jsx(Z,{size:"md",mx:"auto",my:"4",children:u}):e.jsxs(e.Fragment,{children:[e.jsx(G,{mb:"2",value:m().content,onChange:a=>h("content",a.target.value,{shouldDirty:!0,shouldTouch:!0}),rows:2,isRequired:!0,instanceRef:a=>D.current=a,ref:C,onPaste:k,onKeyDown:a=>{(a.ctrlKey||a.metaKey)&&a.key==="Enter"&&d.current&&d.current.requestSubmit()}}),e.jsx(R,{type:"submit",children:"Send"})]})})}function Re({...s}){const t=o.useCallback((r,n)=>e.jsx(L,{message:r,variant:"link",py:"4",px:"6rem",children:l=>e.jsx(J,{event:r,text:l,display:"inline",children:n})}),[]);return e.jsx(ke,{renderContent:t,...s})}const B=o.memo(Re);function Ae({message:s,...t}){return e.jsx(L,{message:s,variant:"link",py:"4",px:"6rem",zIndex:1,children:r=>e.jsx(E,{isTruncated:!0,...t,children:r})})}function Fe({thread:s}){const t=s.messages[s.messages.length-1];return e.jsxs(q,{children:[s.root&&e.jsxs(ae,{px:"2",pt:"2",pb:"1",gap:"2",display:"flex",children:[e.jsx(U,{pubkey:s.root.pubkey,size:"xs"}),e.jsx(_,{fontWeight:"bold",pubkey:s.root.pubkey}),e.jsx(oe,{timestamp:t.created_at,ml:"auto"})]}),e.jsx(ie,{px:"2",py:"1",children:s.root?e.jsx(Ae,{message:s.root}):e.jsx(O,{})}),e.jsx(ce,{px:"2",pb:"2",pt:"0",children:e.jsx(we,{thread:s})})]})}function Ie(){const{threads:s}=H(),t=Object.values(s).sort((r,n)=>n.messages[n.messages.length-1].created_at-r.messages[r.messages.length-1].created_at);return e.jsx(e.Fragment,{children:t.map(r=>e.jsx(Fe,{thread:r},r.rootId))})}function I({thread:s,pubkey:t}){const r=z(s.messages,5,!0);return e.jsxs(e.Fragment,{children:[e.jsxs(S,{h:"0",flex:1,overflowX:"hidden",overflowY:"scroll",direction:"column",gap:"2",children:[s.root&&e.jsx(B,{messages:[s.root],showThreadButton:!1}),r.map(n=>e.jsx(B,{messages:n.events,showThreadButton:!1},n.id))]}),e.jsx(K,{flexShrink:0,pubkey:t,rootId:s.rootId})]})}function Pe({threadId:s,pubkey:t,...r}){const{threads:n,getRoot:l}=H(),u=n[s],[i,m]=o.useState(!1),h=async()=>{if(!u)return e.jsx(O,{});const x=u.messages.map(c=>{const g=f.getOrCreateContainer(c.id,"nip04",t,c.content);if(g.plaintext.value===void 0)return f.requestDecrypt(g)}).filter(Boolean);if(u.root){const c=f.getOrCreateContainer(u.root.id,"nip04",t,u.root.content);c.plaintext.value===void 0&&f.requestDecrypt(c)}m(!0),Promise.all(x).finally(()=>m(!1))},j=()=>s==="list"?e.jsx(Ie,{}):u?e.jsx(I,{thread:u,pubkey:t}):e.jsx(I,{thread:{rootId:s,messages:[],root:l(s)},pubkey:t});return e.jsxs(Q,{placement:"right",size:"lg",...r,children:[e.jsx(ee,{}),e.jsxs(se,{bgColor:"var(--chakra-colors-chakra-body-bg)",children:[e.jsx(te,{}),e.jsxs(ne,{p:"2",display:"flex",gap:"4",children:[e.jsx(E,{children:"Threads"}),e.jsx(R,{size:"sm",onClick:h,isLoading:i,children:"Decrypt All"})]}),e.jsx(re,{px:"2",pt:"0",pb:"2",gap:"2",display:"flex",flexDirection:"column",children:j()})]})]})}const Le=o.memo(({messages:s})=>{const t=o.useMemo(()=>s.filter(n=>!n.tags.some(l=>l[0]==="e"&&l[3]==="root")),[s.length]),r=o.useMemo(()=>z(t),[t]);return e.jsx(e.Fragment,{children:r.map(n=>e.jsx(B,{messages:n.events,reverse:!0},n.id))})});function Ee({pubkey:s}){var T;const t=de(),{autoDecryptDMs:r}=xe(),n=ge(),l=me(),{router:u}=o.useContext(pe),i=fe(u);o.useEffect(()=>{var d;(d=l.state)!=null&&d.thread&&i.index.current===null&&i.set(1)},[l]);const m=o.useCallback(()=>{i.set(0),n(".",{state:{thread:"list"}})},[i,n]),h=o.useCallback(()=>{i.index.current!==null&&i.index.current>0?n(-i.index.current):n(".",{state:{thread:void 0}}),i.reset()},[i,n]),j=o.useCallback(d=>{var b;const a=d.pubkey,p=(b=d.tags.find(M=>M[0]==="p"))==null?void 0:b[1];return a===t.pubkey&&p===s||a===s&&p===t.pubkey},[t,s]),x=w(s),c=w(t.pubkey),{loader:g,timeline:v}=he(`${F(s)}-${F(t.pubkey)}-messages`,je.from(c==null?void 0:c.inboxes,c==null?void 0:c.outboxes,x==null?void 0:x.inboxes,x==null?void 0:x.outboxes),[{kinds:[P.EncryptedDirectMessage],"#p":[t.pubkey,s],authors:[s,t.pubkey]}],{eventFilter:j}),[D,C]=o.useState(!1),k=async()=>{const d=v.map(a=>{const p=f.getOrCreateContainer(a.id,"nip04",s,a.content);return f.requestDecrypt(p)}).filter(Boolean);C(!0),Promise.all(d).finally(()=>C(!1))},y=Ce(g);return e.jsx(Be,{timeline:g,children:e.jsxs(ye,{callback:y,children:[e.jsxs(q,{size:"sm",flexShrink:0,p:"2",flexDirection:"row",children:[e.jsxs(S,{gap:"2",alignItems:"center",children:[e.jsx(be,{}),e.jsx(U,{pubkey:s,size:"sm"}),e.jsx(_,{pubkey:s,fontWeight:"bold"}),e.jsx(ve,{pubkey:s,onlyIcon:!0})]}),e.jsxs(De,{ml:"auto",children:[!r&&e.jsx(R,{onClick:k,isLoading:D,children:"Decrypt All"}),e.jsx(Te,{"aria-label":"Threads",title:"Threads",icon:e.jsx(Me,{boxSize:5}),onClick:m})]})]}),e.jsxs(S,{h:"0",flex:1,overflowX:"hidden",overflowY:"scroll",direction:"column-reverse",gap:"2",py:"4",px:"2",children:[e.jsx(Le,{messages:v}),e.jsx(Se,{timeline:g})]}),e.jsx(K,{flexShrink:0,pubkey:s}),((T=l.state)==null?void 0:T.thread)&&e.jsx(Pe,{isOpen:!0,onClose:h,threadId:l.state.thread,pubkey:s})]})})}function qe(){const{pubkey:s}=le();return e.jsx(ue,{children:e.jsx(Ee,{pubkey:s})})}export{qe as default};
//# sourceMappingURL=chat-BTWO807w.js.map
