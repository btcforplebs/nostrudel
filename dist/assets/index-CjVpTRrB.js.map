{"version":3,"file":"index-CjVpTRrB.js","sources":["../../src/helpers/function.ts","../../src/views/map/timeline.tsx","../../src/views/map/index.tsx"],"sourcesContent":["// copied from https://dev.to/bwca/create-a-debounce-function-from-scratch-in-typescript-560m\nexport function debounce<A = unknown, R = void>(fn: (args: A) => R, ms: number): (args: A) => Promise<R> {\n  let timer: number;\n\n  const debouncedFunc = (args: A): Promise<R> =>\n    new Promise((resolve) => {\n      if (timer) {\n        window.clearTimeout(timer);\n      }\n\n      timer = window.setTimeout(() => {\n        resolve(fn(args));\n      }, ms);\n    });\n\n  return debouncedFunc;\n}\n","import React from \"react\";\nimport { kinds } from \"nostr-tools\";\n\nimport { ErrorBoundary } from \"../../components/error-boundary\";\nimport StreamNote from \"../../components/timeline-page/generic-note-timeline/stream-note\";\nimport TimelineLoader from \"../../classes/timeline-loader\";\nimport { NostrEvent } from \"../../types/nostr-event\";\nimport TimelineNote from \"../../components/note/timeline-note\";\nimport { useObservable } from \"applesauce-react\";\n\nconst RenderEvent = React.memo(({ event, focused }: { event: NostrEvent; focused?: boolean }) => {\n  switch (event.kind) {\n    case kinds.ShortTextNote:\n      return <TimelineNote event={event} variant={focused ? \"elevated\" : undefined} />;\n    case kinds.LiveEvent:\n      return <StreamNote event={event} />;\n    default:\n      return null;\n  }\n});\n\nconst MapTimeline = React.memo(({ timeline, focused }: { timeline: TimelineLoader; focused?: string }) => {\n  const events = useObservable(timeline.timeline);\n\n  return (\n    <>\n      {events?.map((event) => (\n        <ErrorBoundary key={event.id} event={event}>\n          <RenderEvent event={event} focused={focused === event.id} />\n        </ErrorBoundary>\n      ))}\n    </>\n  );\n});\n\nexport default MapTimeline;\n","import { useCallback, useEffect, useState } from \"react\";\nimport { useNavigate, useSearchParams } from \"react-router-dom\";\nimport { Button, Flex } from \"@chakra-ui/react\";\nimport { kinds } from \"nostr-tools\";\nimport { useObservable } from \"applesauce-react\";\nimport ngeohash from \"ngeohash\";\nimport \"leaflet/dist/leaflet.css\";\nimport L from \"leaflet\";\nimport \"leaflet.locatecontrol/dist/L.Control.Locate.min.css\";\nimport \"leaflet.locatecontrol\";\n\nimport useTimelineLoader from \"../../hooks/use-timeline-loader\";\nimport { useReadRelays } from \"../../hooks/use-client-relays\";\n\nimport { debounce } from \"../../helpers/function\";\nimport TimelineActionAndStatus from \"../../components/timeline/timeline-action-and-status\";\nimport { NostrEvent } from \"../../types/nostr-event\";\nimport MapTimeline from \"./timeline\";\n\nimport useEventMarkers from \"./hooks/use-event-markers\";\nimport LeafletMap from \"./components/leaflet-map\";\n\nfunction getPrecision(zoom: number) {\n  if (zoom <= 4) return 1;\n  if (zoom <= 8) return 2;\n  if (zoom <= 10) return 3;\n  if (zoom <= 12) return 4;\n  if (zoom <= 14) return 5;\n  if (zoom <= 16) return 6;\n  if (zoom <= 18) return 7;\n  return 7;\n}\n\nexport default function MapView() {\n  const navigate = useNavigate();\n  const [map, setMap] = useState<L.Map>();\n  const [searchParams, setSearchParams] = useSearchParams();\n\n  // listen for map move event\n  useEffect(() => {\n    if (!map) return;\n\n    const listener = debounce(() => {\n      const center = map.getCenter();\n      const hash = ngeohash.encode(center.lat, center.lng, 5);\n\n      setSearchParams({ hash }, { replace: true });\n    }, 1000);\n\n    map.addEventListener(\"move\", listener);\n    return () => {\n      map.removeEventListener(\"move\", listener);\n    };\n  });\n\n  const [cells, setCells] = useState<string[]>([]);\n\n  const readRelays = useReadRelays();\n  const { loader, timeline } = useTimelineLoader(\n    \"geo-events\",\n    readRelays,\n    cells.length > 0 ? { \"#g\": cells, kinds: [kinds.ShortTextNote] } : undefined,\n  );\n\n  const setCellsFromMap = useCallback(() => {\n    if (!map) return;\n    const bbox = map.getBounds();\n    const hashes = ngeohash.bboxes(\n      bbox.getSouth(),\n      bbox.getWest(),\n      bbox.getNorth(),\n      bbox.getEast(),\n      getPrecision(map.getZoom()),\n    );\n\n    setCells(hashes);\n  }, [map]);\n\n  const [focused, setFocused] = useState<string>();\n  const handleMarkerClick = useCallback((event: NostrEvent) => {\n    document.querySelector(`[data-event-id=\"${event.id}\"]`)?.scrollIntoView();\n    setFocused(event.id);\n  }, []);\n\n  const events = useObservable(loader.timeline) ?? [];\n  useEventMarkers(events, map, handleMarkerClick);\n\n  return (\n    <Flex overflow={{ lg: \"hidden\" }} h={{ lg: \"full\" }} direction={{ base: \"column-reverse\", lg: \"row\" }}>\n      <Flex w={{ base: \"full\", lg: \"xl\" }} direction=\"column\" p=\"2\" gap=\"2\">\n        <Flex gap=\"2\">\n          <Button flexShrink={0} onClick={() => navigate(-1)}>\n            Back\n          </Button>\n          <Button colorScheme=\"primary\" onClick={setCellsFromMap} flex={1}>\n            Search this area\n          </Button>\n        </Flex>\n\n        <Flex overflowY=\"auto\" overflowX=\"hidden\" gap=\"2\" direction=\"column\" h=\"full\">\n          <MapTimeline timeline={loader} focused={focused} />\n          {cells.length > 0 && <TimelineActionAndStatus timeline={loader} />}\n        </Flex>\n      </Flex>\n\n      <LeafletMap onCreate={setMap} h={{ base: \"50vh\", lg: \"100vh\" }} />\n    </Flex>\n  );\n}\n"],"names":["debounce","fn","ms","timer","args","resolve","RenderEvent","React","event","focused","kinds","TimelineNote","jsx","StreamNote","MapTimeline","timeline","events","useObservable","ErrorBoundary","getPrecision","zoom","MapView","navigate","useNavigate","map","setMap","useState","searchParams","setSearchParams","useSearchParams","useEffect","listener","center","hash","ngeohash","cells","setCells","readRelays","useReadRelays","loader","useTimelineLoader","setCellsFromMap","useCallback","bbox","hashes","setFocused","handleMarkerClick","_a","useEventMarkers","Flex","jsxs","Button","TimelineActionAndStatus","LeafletMap"],"mappings":"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"}