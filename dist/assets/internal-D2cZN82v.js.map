{"version":3,"file":"internal-D2cZN82v.js","sources":["../../src/views/relays/cache/database/internal.tsx"],"sourcesContent":["import { useState } from \"react\";\nimport { addEvents, countEvents, countEventsByKind, getEventUID, updateUsed } from \"nostr-idb\";\nimport {\n  Button,\n  ButtonGroup,\n  Card,\n  Flex,\n  FormControl,\n  FormLabel,\n  Heading,\n  Input,\n  NumberDecrementStepper,\n  NumberIncrementStepper,\n  NumberInput,\n  NumberInputField,\n  NumberInputStepper,\n  Text,\n} from \"@chakra-ui/react\";\nimport { useAsync } from \"react-use\";\nimport { NostrEvent } from \"nostr-tools\";\n\nimport { localDatabase } from \"../../../../services/local-relay\";\nimport EventKindsPieChart from \"../../../../components/charts/event-kinds-pie-chart\";\nimport EventKindsTable from \"../../../../components/charts/event-kinds-table\";\nimport ImportEventsButton from \"./components/import-events-button\";\nimport ExportEventsButton from \"./components/export-events-button\";\nimport { clearCacheData, deleteDatabase } from \"../../../../services/db\";\nimport useSubject from \"../../../../hooks/use-subject\";\nimport localSettings from \"../../../../services/local-settings\";\n\nasync function importEvents(events: NostrEvent[]) {\n  await addEvents(localDatabase, events);\n  await updateUsed(\n    localDatabase,\n    events.map((e) => getEventUID(e)),\n  );\n}\nasync function exportEvents() {\n  return (await localDatabase.getAll(\"events\")).map((row) => row.event);\n}\n\nexport default function InternalDatabasePage() {\n  const { value: count } = useAsync(async () => await countEvents(localDatabase), []);\n  const { value: kinds } = useAsync(async () => await countEventsByKind(localDatabase), []);\n\n  const maxEvents = useSubject(localSettings.idbMaxEvents);\n\n  const [clearing, setClearing] = useState(false);\n  const handleClearData = async () => {\n    setClearing(true);\n    await clearCacheData();\n    setClearing(false);\n  };\n\n  const [deleting, setDeleting] = useState(false);\n  const handleDeleteDatabase = async () => {\n    setDeleting(true);\n    await deleteDatabase();\n    setDeleting(false);\n  };\n\n  return (\n    <>\n      <Text>Total events: {count ?? \"Loading...\"}</Text>\n      <ButtonGroup flexWrap=\"wrap\">\n        <ImportEventsButton onLoad={importEvents} />\n        <ExportEventsButton getEvents={exportEvents} />\n      </ButtonGroup>\n      <ButtonGroup flexWrap=\"wrap\">\n        <Button onClick={handleClearData} isLoading={clearing} colorScheme=\"primary\" variant=\"outline\">\n          Clear cache\n        </Button>\n        <Button colorScheme=\"red\" onClick={handleDeleteDatabase} isLoading={deleting}>\n          Delete database\n        </Button>\n      </ButtonGroup>\n      <FormControl>\n        <FormLabel>Maximum number of events</FormLabel>\n        <NumberInput\n          maxW=\"xs\"\n          value={maxEvents}\n          onChange={(s, v) => {\n            if (Number.isFinite(v)) localSettings.idbMaxEvents.next(v);\n            else localSettings.idbMaxEvents.clear();\n          }}\n          step={1000}\n        >\n          <NumberInputField />\n          <NumberInputStepper>\n            <NumberIncrementStepper />\n            <NumberDecrementStepper />\n          </NumberInputStepper>\n        </NumberInput>\n      </FormControl>\n      <Flex gap=\"2\" wrap=\"wrap\" alignItems=\"flex-start\" w=\"full\">\n        {kinds && (\n          <>\n            <Card p=\"2\" minW=\"sm\" maxW=\"lg\" flex={1}>\n              <Heading size=\"sm\">Events by kind</Heading>\n              <EventKindsPieChart kinds={kinds} />\n            </Card>\n            <Card p=\"2\" minW=\"sm\" maxW=\"md\" flex={1}>\n              <EventKindsTable kinds={kinds} />\n            </Card>\n          </>\n        )}\n      </Flex>\n    </>\n  );\n}\n"],"names":["importEvents","events","addEvents","localDatabase","updateUsed","e","getEventUID","exportEvents","row","InternalDatabasePage","count","useAsync","countEvents","kinds","countEventsByKind","maxEvents","useSubject","localSettings","clearing","setClearing","useState","handleClearData","clearCacheData","deleting","setDeleting","handleDeleteDatabase","deleteDatabase","jsxs","Fragment","Text","ButtonGroup","jsx","ImportEventsButton","ExportEventsButton","Button","FormControl","FormLabel","NumberInput","s","v","NumberInputField","NumberInputStepper","NumberIncrementStepper","NumberDecrementStepper","Flex","Card","Heading","EventKindsPieChart","EventKindsTable"],"mappings":"4VA8BA,eAAeA,EAAaC,EAAsB,CAC1C,MAAAC,EAAUC,EAAeF,CAAM,EAC/B,MAAAG,EACJD,EACAF,EAAO,IAAKI,GAAMC,EAAYD,CAAC,CAAC,CAAA,CAEpC,CACA,eAAeE,GAAe,CACpB,OAAA,MAAMJ,EAAc,OAAO,QAAQ,GAAG,IAAKK,GAAQA,EAAI,KAAK,CACtE,CAEA,SAAwBC,GAAuB,CACvC,KAAA,CAAE,MAAOC,CAAA,EAAUC,EAAS,SAAY,MAAMC,EAAYT,CAAa,EAAG,CAAA,CAAE,EAC5E,CAAE,MAAOU,CAAA,EAAUF,EAAS,SAAY,MAAMG,EAAkBX,CAAa,EAAG,CAAA,CAAE,EAElFY,EAAYC,EAAWC,EAAc,YAAY,EAEjD,CAACC,EAAUC,CAAW,EAAIC,WAAS,EAAK,EACxCC,EAAkB,SAAY,CAClCF,EAAY,EAAI,EAChB,MAAMG,EAAe,EACrBH,EAAY,EAAK,CAAA,EAGb,CAACI,EAAUC,CAAW,EAAIJ,WAAS,EAAK,EACxCK,EAAuB,SAAY,CACvCD,EAAY,EAAI,EAChB,MAAME,EAAe,EACrBF,EAAY,EAAK,CAAA,EAGnB,OAEIG,EAAA,KAAAC,WAAA,CAAA,SAAA,CAAAD,OAACE,EAAK,CAAA,SAAA,CAAA,iBAAenB,GAAS,YAAA,EAAa,EAC3CiB,EAAAA,KAACG,EAAY,CAAA,SAAS,OACpB,SAAA,CAACC,EAAAA,IAAAC,EAAA,CAAmB,OAAQhC,CAAc,CAAA,EAC1C+B,EAAAA,IAACE,EAAmB,CAAA,UAAW1B,CAAc,CAAA,CAAA,EAC/C,EACAoB,EAAAA,KAACG,EAAY,CAAA,SAAS,OACpB,SAAA,CAACC,EAAAA,IAAAG,EAAA,CAAO,QAASb,EAAiB,UAAWH,EAAU,YAAY,UAAU,QAAQ,UAAU,SAE/F,aAAA,CAAA,EACAa,EAAAA,IAACG,GAAO,YAAY,MAAM,QAAST,EAAsB,UAAWF,EAAU,SAE9E,iBAAA,CAAA,CAAA,EACF,SACCY,EACC,CAAA,SAAA,CAAAJ,EAAAA,IAACK,GAAU,SAAwB,0BAAA,CAAA,EACnCT,EAAA,KAACU,EAAA,CACC,KAAK,KACL,MAAOtB,EACP,SAAU,CAACuB,EAAGC,IAAM,CACd,OAAO,SAASA,CAAC,EAAiBtB,EAAA,aAAa,KAAKsB,CAAC,EACpDtB,EAAc,aAAa,OAClC,EACA,KAAM,IAEN,SAAA,CAAAc,EAAA,IAACS,EAAiB,EAAA,SACjBC,EACC,CAAA,SAAA,CAAAV,EAAA,IAACW,EAAuB,EAAA,QACvBC,EAAuB,EAAA,CAAA,EAC1B,CAAA,CAAA,CACF,CAAA,EACF,EACAZ,EAAA,IAACa,EAAK,CAAA,IAAI,IAAI,KAAK,OAAO,WAAW,aAAa,EAAE,OACjD,SAAA/B,GAEGc,EAAAA,KAAAC,EAAAA,SAAA,CAAA,SAAA,CAACD,EAAAA,KAAAkB,EAAA,CAAK,EAAE,IAAI,KAAK,KAAK,KAAK,KAAK,KAAM,EACpC,SAAA,CAACd,EAAA,IAAAe,EAAA,CAAQ,KAAK,KAAK,SAAc,iBAAA,EACjCf,MAACgB,GAAmB,MAAAlC,EAAc,CAAA,EACpC,EACCkB,EAAA,IAAAc,EAAA,CAAK,EAAE,IAAI,KAAK,KAAK,KAAK,KAAK,KAAM,EACpC,SAACd,EAAA,IAAAiB,EAAA,CAAgB,MAAAnC,CAAc,CAAA,EACjC,CAAA,CAAA,CACF,CAEJ,CAAA,CACF,CAAA,CAAA,CAEJ"}