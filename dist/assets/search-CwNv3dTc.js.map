{"version":3,"file":"search-CwNv3dTc.js","sources":["../../src/views/wiki/search.tsx"],"sourcesContent":["import { useEffect, useState } from \"react\";\nimport { Navigate } from \"react-router-dom\";\nimport { Button, Flex, Heading, Input, Link } from \"@chakra-ui/react\";\nimport { Link as RouterLink } from \"react-router-dom\";\nimport { Filter, NostrEvent } from \"nostr-tools\";\nimport { useForm } from \"react-hook-form\";\nimport { Subscription, getEventUID } from \"nostr-idb\";\n\nimport VerticalPageLayout from \"../../components/vertical-page-layout\";\nimport useRouteSearchValue from \"../../hooks/use-route-search-value\";\nimport { subscribeMany } from \"../../helpers/relay\";\nimport { DEFAULT_SEARCH_RELAYS, WIKI_RELAYS } from \"../../const\";\nimport { WIKI_PAGE_KIND } from \"../../helpers/nostr/wiki\";\nimport { localRelay } from \"../../services/local-relay\";\nimport WikiPageResult from \"./components/wiki-page-result\";\nimport dictionaryService from \"../../services/dictionary\";\nimport { useWebOfTrust } from \"../../providers/global/web-of-trust-provider\";\n\nexport default function WikiSearchView() {\n  const webOfTrust = useWebOfTrust();\n  const { value: query, setValue: setQuery } = useRouteSearchValue(\"q\");\n  if (!query) return <Navigate to=\"/wiki\" />;\n\n  const { register, handleSubmit } = useForm({ defaultValues: { search: query } });\n  const onSubmit = handleSubmit((values) => {\n    setQuery(values.search);\n  });\n\n  const [results, setResults] = useState<NostrEvent[]>([]);\n\n  useEffect(() => {\n    setResults([]);\n\n    const filter: Filter = { kinds: [WIKI_PAGE_KIND], search: query };\n\n    const seen = new Set<string>();\n    const handleEvent = (event: NostrEvent) => {\n      dictionaryService.handleEvent(event);\n      if (seen.has(getEventUID(event))) return;\n      setResults((arr) => arr.concat(event));\n      seen.add(getEventUID(event));\n    };\n\n    const remoteSearchSub = subscribeMany([...DEFAULT_SEARCH_RELAYS, ...WIKI_RELAYS], [filter], {\n      onevent: handleEvent,\n      oneose: () => remoteSearchSub.close(),\n    });\n\n    if (localRelay) {\n      const localSearchSub: Subscription = localRelay.subscribe([filter], {\n        onevent: handleEvent,\n        oneose: () => localSearchSub.close(),\n      });\n    }\n  }, [query, setResults]);\n\n  const sorted = webOfTrust ? webOfTrust.sortByDistanceAndConnections(results, (p) => p.pubkey) : results;\n\n  return (\n    <VerticalPageLayout>\n      <Flex gap=\"2\" wrap=\"wrap\">\n        <Heading mr=\"4\">\n          <Link as={RouterLink} to=\"/wiki\">\n            Wikifreedia\n          </Link>\n        </Heading>\n        <Flex gap=\"2\" as=\"form\" maxW=\"md\" onSubmit={onSubmit} w=\"full\">\n          <Input\n            {...register(\"search\", { required: true })}\n            type=\"search\"\n            name=\"search\"\n            autoComplete=\"on\"\n            w=\"sm\"\n            placeholder=\"Search Wikifreedia\"\n            isRequired\n          />\n          <Button type=\"submit\" colorScheme=\"primary\">\n            Search\n          </Button>\n        </Flex>\n      </Flex>\n      {sorted.map((page) => (\n        <WikiPageResult key={page.id} page={page} />\n      ))}\n    </VerticalPageLayout>\n  );\n}\n"],"names":["WikiSearchView","webOfTrust","useWebOfTrust","query","setQuery","useRouteSearchValue","jsx","Navigate","register","handleSubmit","useForm","onSubmit","values","results","setResults","useState","useEffect","filter","WIKI_PAGE_KIND","seen","handleEvent","event","dictionaryService","getEventUID","arr","remoteSearchSub","subscribeMany","DEFAULT_SEARCH_RELAYS","WIKI_RELAYS","localRelay","localSearchSub","sorted","p","VerticalPageLayout","jsxs","Flex","Heading","Link","RouterLink","Input","Button","page","WikiPageResult"],"mappings":"2OAkBA,SAAwBA,GAAiB,CACvC,MAAMC,EAAaC,IACb,CAAE,MAAOC,EAAO,SAAUC,GAAaC,EAAoB,GAAG,EACpE,GAAI,CAACF,EAAO,OAAQG,EAAA,IAAAC,EAAA,CAAS,GAAG,OAAQ,CAAA,EAElC,KAAA,CAAE,SAAAC,EAAU,aAAAC,CAAA,EAAiBC,EAAQ,CAAE,cAAe,CAAE,OAAQP,CAAM,CAAA,CAAG,EACzEQ,EAAWF,EAAcG,GAAW,CACxCR,EAASQ,EAAO,MAAM,CAAA,CACvB,EAEK,CAACC,EAASC,CAAU,EAAIC,EAAA,SAAuB,CAAE,CAAA,EAEvDC,EAAAA,UAAU,IAAM,CACdF,EAAW,CAAE,CAAA,EAEb,MAAMG,EAAiB,CAAE,MAAO,CAACC,CAAc,EAAG,OAAQf,GAEpDgB,MAAW,IACXC,EAAeC,GAAsB,CACzCC,EAAkB,YAAYD,CAAK,EAC/B,CAAAF,EAAK,IAAII,EAAYF,CAAK,CAAC,IAC/BP,EAAYU,GAAQA,EAAI,OAAOH,CAAK,CAAC,EAChCF,EAAA,IAAII,EAAYF,CAAK,CAAC,EAAA,EAGvBI,EAAkBC,EAAc,CAAC,GAAGC,EAAuB,GAAGC,CAAW,EAAG,CAACX,CAAM,EAAG,CAC1F,QAASG,EACT,OAAQ,IAAMK,EAAgB,MAAM,CAAA,CACrC,EAED,GAAII,EAAY,CACd,MAAMC,EAA+BD,EAAW,UAAU,CAACZ,CAAM,EAAG,CAClE,QAASG,EACT,OAAQ,IAAMU,EAAe,MAAM,CAAA,CACpC,CACH,CAAA,EACC,CAAC3B,EAAOW,CAAU,CAAC,EAEhB,MAAAiB,EAAS9B,EAAaA,EAAW,6BAA6BY,EAAUmB,GAAMA,EAAE,MAAM,EAAInB,EAEhG,cACGoB,EACC,CAAA,SAAA,CAAAC,EAAA,KAACC,EAAK,CAAA,IAAI,IAAI,KAAK,OACjB,SAAA,CAAC7B,EAAA,IAAA8B,EAAA,CAAQ,GAAG,IACV,SAAC9B,EAAAA,IAAA+B,EAAA,CAAK,GAAIC,EAAY,GAAG,QAAQ,SAAA,aAEjC,CAAA,EACF,EACAJ,EAAAA,KAACC,EAAK,CAAA,IAAI,IAAI,GAAG,OAAO,KAAK,KAAK,SAAAxB,EAAoB,EAAE,OACtD,SAAA,CAAAL,EAAA,IAACiC,EAAA,CACE,GAAG/B,EAAS,SAAU,CAAE,SAAU,GAAM,EACzC,KAAK,SACL,KAAK,SACL,aAAa,KACb,EAAE,KACF,YAAY,qBACZ,WAAU,EAAA,CACZ,QACCgC,EAAO,CAAA,KAAK,SAAS,YAAY,UAAU,SAE5C,SAAA,CAAA,EACF,CAAA,EACF,EACCT,EAAO,IAAKU,SACVC,EAA6B,CAAA,KAAAD,CAAA,EAATA,EAAK,EAAgB,CAC3C,CACH,CAAA,CAAA,CAEJ"}