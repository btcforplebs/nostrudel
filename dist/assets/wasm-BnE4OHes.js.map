{"version":3,"file":"wasm-BnE4OHes.js","sources":["../../src/views/relays/cache/database/wasm.tsx"],"sourcesContent":["import { useCallback, useEffect, useState } from \"react\";\nimport {\n  Button,\n  ButtonGroup,\n  Card,\n  Flex,\n  FormControl,\n  FormLabel,\n  Heading,\n  NumberDecrementStepper,\n  NumberIncrementStepper,\n  NumberInput,\n  NumberInputField,\n  NumberInputStepper,\n  Text,\n} from \"@chakra-ui/react\";\nimport { NostrEvent } from \"nostr-tools\";\n\nimport { localRelay } from \"../../../../services/local-relay\";\nimport WasmRelay from \"../../../../services/wasm-relay\";\nimport EventKindsPieChart from \"../../../../components/charts/event-kinds-pie-chart\";\nimport EventKindsTable from \"../../../../components/charts/event-kinds-table\";\nimport ImportEventsButton from \"./components/import-events-button\";\nimport ExportEventsButton from \"./components/export-events-button\";\nimport useSubject from \"../../../../hooks/use-subject\";\nimport localSettings from \"../../../../services/local-settings\";\n\nexport default function WasmDatabasePage() {\n  const relay = localRelay;\n  if (!(relay instanceof WasmRelay)) return null;\n  const worker = relay.worker;\n  if (!worker) return null;\n\n  const [summary, setSummary] = useState<Record<string, number>>();\n  const persistForDays = useSubject(localSettings.wasmPersistForDays);\n\n  const total = summary ? Object.values(summary).reduce((t, v) => t + v, 0) : undefined;\n\n  const refresh = useCallback(async () => {\n    await worker.summary().then((v) => setSummary(v));\n  }, [setSummary, worker]);\n\n  const importEvents = useCallback(\n    async (events: NostrEvent[]) => {\n      const batchSize = 100;\n      const queue = Array.from(events);\n\n      const next = () => {\n        const p: Promise<any>[] = [];\n        for (let i = 0; i < batchSize; i++) {\n          const event = queue.pop();\n          if (!event) break;\n          p.push(worker.event(event));\n        }\n\n        return Promise.all(p);\n      };\n\n      while (queue.length > 0) {\n        await next();\n        await refresh();\n      }\n    },\n    [worker],\n  );\n  const exportEvents = useCallback(async () => {\n    return worker.query([\"REQ\", \"export\", {}]);\n  }, [worker]);\n\n  const deleteKind = useCallback(\n    async (kind: string) => {\n      const k = parseInt(kind);\n      if (confirm(`Are you sure you want to delete all kind ${k} events?`)) {\n        await worker.delete([\"REQ\", \"delete-\" + k, { kinds: [k] }]);\n        refresh();\n      }\n    },\n    [worker, refresh],\n  );\n\n  const [deleting, setDeleting] = useState(false);\n  const deleteDatabase = useCallback(async () => {\n    try {\n      setDeleting(true);\n      if (localRelay instanceof WasmRelay) {\n        await localRelay.wipe();\n        location.reload();\n      }\n    } catch (error) {}\n    setDeleting(false);\n  }, []);\n\n  useEffect(() => {\n    refresh();\n  }, []);\n\n  return (\n    <>\n      <Text>Wasm Relay Database</Text>\n      <Text>Total events: {total ?? \"Loading...\"}</Text>\n      <ButtonGroup flexWrap=\"wrap\">\n        <ImportEventsButton onLoad={importEvents} />\n        <ExportEventsButton getEvents={exportEvents} />\n        <Button colorScheme=\"red\" onClick={deleteDatabase} isLoading={deleting}>\n          Delete database\n        </Button>\n      </ButtonGroup>\n\n      <FormControl>\n        <FormLabel>Remove events older than X days</FormLabel>\n        <NumberInput\n          maxW=\"xs\"\n          value={persistForDays ?? undefined}\n          onChange={(s, v) => {\n            if (Number.isFinite(v)) localSettings.wasmPersistForDays.next(v);\n            else localSettings.wasmPersistForDays.clear();\n          }}\n          step={1000}\n        >\n          <NumberInputField />\n          <NumberInputStepper>\n            <NumberIncrementStepper />\n            <NumberDecrementStepper />\n          </NumberInputStepper>\n        </NumberInput>\n      </FormControl>\n      <Flex gap=\"2\" wrap=\"wrap\" alignItems=\"flex-start\" w=\"full\">\n        {summary && (\n          <>\n            <Card p=\"2\" minW=\"sm\" maxW=\"lg\" flex={1}>\n              <Heading size=\"sm\">Events by kind</Heading>\n              <EventKindsPieChart kinds={summary} />\n            </Card>\n            <Card p=\"2\" minW=\"sm\" maxW=\"md\" flex={1}>\n              <EventKindsTable kinds={summary} deleteKind={deleteKind} />\n            </Card>\n          </>\n        )}\n      </Flex>\n    </>\n  );\n}\n"],"names":["WasmDatabasePage","relay","localRelay","WasmRelay","worker","summary","setSummary","useState","persistForDays","useSubject","localSettings","total","t","v","refresh","useCallback","importEvents","events","queue","next","p","i","event","exportEvents","deleteKind","kind","k","deleting","setDeleting","deleteDatabase","useEffect","jsxs","Fragment","jsx","Text","ButtonGroup","ImportEventsButton","ExportEventsButton","Button","FormControl","FormLabel","NumberInput","s","NumberInputField","NumberInputStepper","NumberIncrementStepper","NumberDecrementStepper","Flex","Card","Heading","EventKindsPieChart","EventKindsTable"],"mappings":"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"}